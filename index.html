<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Konwerter CRON → Proxmox Schedule</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 0;
      background: linear-gradient(120deg, #e0e7ff 0%, #f7f7fa 100%);
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      margin: 3em auto;
      background: #fff;
      padding: 2.5em 2em 2em 2em;
      border-radius: 18px;
      box-shadow: 0 4px 24px #0002;
      position: relative;
    }
    h1 {
      text-align: center;
      font-size: 2.1em;
      margin-bottom: 0.5em;
      color: #2a3a5e;
    }
    label {
      font-weight: 500;
      margin-bottom: 0.5em;
      color: #2a3a5e;
    }
    textarea, input[type=text] {
      width: 100%;
      padding: 0.7em;
      border: 1.5px solid #bfc7d1;
      border-radius: 7px;
      font-size: 1.1em;
      margin-bottom: 1.2em;
      background: #f5f7fa;
      transition: border 0.2s;
    }
    textarea:focus, input[type=text]:focus {
      border: 1.5px solid #6c63ff;
      outline: none;
    }
    .btn {
      display: inline-block;
      background: linear-gradient(90deg, #6c63ff 0%, #48b1f3 100%);
      color: #fff;
      font-weight: 600;
      border: none;
      border-radius: 7px;
      padding: 0.7em 1.5em;
      font-size: 1.1em;
      cursor: pointer;
      box-shadow: 0 2px 8px #6c63ff22;
      transition: background 0.2s, box-shadow 0.2s;
      margin-bottom: 1.2em;
    }
    .btn:hover {
      background: linear-gradient(90deg, #48b1f3 0%, #6c63ff 100%);
      box-shadow: 0 4px 16px #6c63ff33;
    }
    .result-card {
      background: #f0f4ff;
      border-radius: 10px;
      padding: 1.2em 1em 1em 1em;
      margin-bottom: 1.5em;
      box-shadow: 0 2px 8px #6c63ff11;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 1.15em;
      min-height: 2.5em;
    }
    .result-card .copy-btn {
      background: none;
      border: none;
      color: #6c63ff;
      font-size: 1.3em;
      cursor: pointer;
      margin-left: 0.5em;
      transition: color 0.2s;
    }
    .result-card .copy-btn:hover {
      color: #48b1f3;
    }
    .error {
      color: #c00;
      font-weight: 500;
    }
    .examples, .popular {
      margin: 2.5em 0 1.5em 0;
    }
    .examples h3, .popular h3 {
      color: #2a3a5e;
      font-size: 1.15em;
      margin-bottom: 0.7em;
    }
    .example-list, .popular-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .example-list li, .popular-list li {
      background: #f7f7fa;
      border-radius: 7px;
      margin-bottom: 0.5em;
      padding: 0.7em 1em;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      transition: background 0.2s;
      border: 1px solid #e0e7ff;
    }
    .example-list li:hover, .popular-list li:hover {
      background: #e0e7ff;
    }
    .cron-label {
      font-family: 'Fira Mono', 'Consolas', monospace;
      background: #e0e7ff;
      border-radius: 4px;
      padding: 0.2em 0.5em;
      font-size: 1em;
      margin-right: 0.7em;
      color: #2a3a5e;
    }
    .desc {
      color: #555;
      font-size: 0.98em;
    }
    @media (max-width: 700px) {
      .container { padding: 1em; }
      h1 { font-size: 1.3em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1><i class="fa-solid fa-clock"></i> Konwerter CRON → Proxmox Schedule</h1>
    <label for="cron">Wprowadź wyrażenie CRON (5 pól):</label>
    <textarea id="cron" placeholder="np. 0 22 * * 1-5" autocomplete="off"></textarea>
    <button class="btn" onclick="convert()"><i class="fa-solid fa-arrow-right"></i> Generuj</button>
    <div id="result" class="result-card" style="display:none;"></div>
    <div class="popular">
      <h3><i class="fa-solid fa-fire"></i> Popularne harmonogramy backupów:</h3>
      <ul class="popular-list">
        <li onclick="setExample('0 2 * * *')"><span><span class='cron-label'>0 2 * * *</span> <span class='desc'>Codziennie o 2:00 w nocy</span></span></li>
        <li onclick="setExample('0 3 * * 0')"><span><span class='cron-label'>0 3 * * 0</span> <span class='desc'>W każdą niedzielę o 3:00</span></span></li>
        <li onclick="setExample('0 */4 * * *')"><span><span class='cron-label'>0 */4 * * *</span> <span class='desc'>Co 4 godziny, codziennie</span></span></li>
        <li onclick="setExample('0 1 1 * *')"><span><span class='cron-label'>0 1 1 * *</span> <span class='desc'>Pierwszego dnia miesiąca o 1:00</span></span></li>
        <li onclick="setExample('0 23 * * 1-5')"><span><span class='cron-label'>0 23 * * 1-5</span> <span class='desc'>Od poniedziałku do piątku o 23:00</span></span></li>
        <li onclick="setExample('*/15 8-18 * * 1-5')"><span><span class='cron-label'>*/15 8-18 * * 1-5</span> <span class='desc'>Co 15 minut w godzinach pracy (pon-pt 8:00-18:45)</span></span></li>
        <li onclick="setExample('0 0 * * 6,0')"><span><span class='cron-label'>0 0 * * 6,0</span> <span class='desc'>W weekendy o północy</span></span></li>
        <li onclick="setExample('0 0 1 1 *')"><span><span class='cron-label'>0 0 1 1 *</span> <span class='desc'>Raz w roku, 1 stycznia o północy</span></span></li>
      </ul>
    </div>
    <div class="examples">
      <h3><i class="fa-solid fa-lightbulb"></i> Przykłady CRON:</h3>
      <ul class="example-list">
        <li onclick="setExample('0 22 * * 1-5')"><span><span class='cron-label'>0 22 * * 1-5</span> <span class='desc'>pon-pt 22:00</span></span></li>
        <li onclick="setExample('*/15 8-9 * * 1-5')"><span><span class='cron-label'>*/15 8-9 * * 1-5</span> <span class='desc'>pon-pt 8:00-9:45 co 15 min</span></span></li>
        <li onclick="setExample('5 0 * 8 *')"><span><span class='cron-label'>5 0 * 8 *</span> <span class='desc'>codziennie w sierpniu o 00:05</span></span></li>
        <li onclick="setExample('0 0 1 * *')"><span><span class='cron-label'>0 0 1 * *</span> <span class='desc'>pierwszego dnia miesiąca o 00:00</span></span></li>
        <li onclick="setExample('0 0 * * 0')"><span><span class='cron-label'>0 0 * * 0</span> <span class='desc'>niedziela o 00:00</span></span></li>
        <li onclick="setExample('0 8-16/2 * * *')"><span><span class='cron-label'>0 8-16/2 * * *</span> <span class='desc'>co 2 godziny od 8:00 do 16:00</span></span></li>
      </ul>
    </div>
  </div>
  <script>
    // Mapowanie dni tygodnia CRON -> Proxmox
    const daysMap = ['sun','mon','tue','wed','thu','fri','sat'];
    function expandRangeWithStep(start, end, step) {
      const res = [];
      for (let i = Number(start); i <= Number(end); i += Number(step)) {
        res.push(i);
      }
      return res;
    }
    function cronToProxmox(cron) {
      // Parsowanie i walidacja
      const parts = cron.trim().split(/\s+/);
      if (parts.length !== 5) return {error: 'Wyrażenie CRON musi mieć 5 pól!'};
      let [min, hour, dom, month, dow] = parts;
      // Dni tygodnia
      let proxDOW = '';
      if (dow !== '*' && dow !== '?') {
        proxDOW = dow.split(',').map(d => {
          if (/^[0-7]$/.test(d)) return daysMap[d%7];
          if (/^(\d)-(\d)$/.test(d)) {
            const [a,b] = d.split('-').map(Number);
            return daysMap[a%7]+'..'+daysMap[b%7];
          }
          return d;
        }).join(',');
      }
      // Miesiące
      let proxMonth = '';
      if (month !== '*') {
        proxMonth = month.split(',').map(m => {
          if (/^(\d+)-(\d+)$/.test(m)) {
            const [a,b] = m.split('-');
            return a.padStart(2,'0')+'..'+b.padStart(2,'0');
          }
          return m.padStart(2,'0');
        }).join(',');
      }
      // Dzień miesiąca
      let proxDOM = '';
      if (dom !== '*') {
        proxDOM = dom.split(',').map(d => {
          if (/^(\d+)-(\d+)$/.test(d)) {
            const [a,b] = d.split('-');
            return a.padStart(2,'0')+'..'+b.padStart(2,'0');
          }
          return d.padStart(2,'0');
        }).join(',');
      }
      // Godzina i minuta
      let proxHour = hour, proxMin = min;
      // --- POPRAWKA: obsługa zakresów i kroków ---
      // Zakres godzin z krokiem (np. 8-16/2)
      let hourRangeStepMatch = hour.match(/^(\d+)-(\d+)\/(\d+)$/);
      // Zakres minut z krokiem (np. 0-45/15)
      let minRangeStepMatch = min.match(/^(\d+)-(\d+)\/(\d+)$/);
      // Zakres godzin
      let hourRangeMatch = hour.match(/^(\d+)-(\d+)$/);
      // Krok minut
      let minStepMatch = min.match(/^\*(?:\/(\d+))$/);
      // Krok godzin
      let hourStepMatch = hour.match(/^\*(?:\/(\d+))$/);
      // Krok minut od liczby
      let minNumStepMatch = min.match(/^(\d+)\/(\d+)$/);
      // Krok godzin od liczby
      let hourNumStepMatch = hour.match(/^(\d+)\/(\d+)$/);
      if (hourRangeStepMatch) {
        // Przypadek: 8-16/2 0 => 8,10,12,14,16:0
        const [_, start, end, step] = hourRangeStepMatch;
        proxHour = expandRangeWithStep(start, end, step).join(',');
      }
      if (minRangeStepMatch) {
        // Przypadek: 0-45/15 8 => 8:0,15,30,45
        const [_, start, end, step] = minRangeStepMatch;
        proxMin = expandRangeWithStep(start, end, step).join(',');
      }
      if (hourRangeMatch && minStepMatch) {
        // Przypadek: 8-9 */15 => 8..9:0/15
        proxHour = hourRangeMatch[1]+'..'+hourRangeMatch[2];
        proxMin = '0/'+minStepMatch[1];
      } else if (hourRangeMatch && min !== '*') {
        // Przypadek: 8-9 15 => 8..9:15
        proxHour = hourRangeMatch[1]+'..'+hourRangeMatch[2];
        proxMin = min;
      } else if (hourRangeMatch && min === '*') {
        // Przypadek: 8-9 * => 8..9
        proxHour = hourRangeMatch[1]+'..'+hourRangeMatch[2];
        proxMin = '';
      } else if (hourStepMatch) {
        // Przypadek: */2 15 => 0/2:15
        proxHour = '0/'+hourStepMatch[1];
      } else if (minStepMatch) {
        // Przypadek: * */15 => *:0/15
        proxMin = '0/'+minStepMatch[1];
      } else if (minNumStepMatch) {
        // Przypadek: 5/10 * => *:5/10
        proxMin = minNumStepMatch[1]+'/'+minNumStepMatch[2];
      } else if (hourNumStepMatch) {
        // Przypadek: 2/3 * => 2/3:*
        proxHour = hourNumStepMatch[1]+'/'+hourNumStepMatch[2];
      }
      // Składanie całości
      let schedule = '';
      if (proxDOW) schedule += proxDOW+' ';
      if (proxMonth || proxDOM) {
        schedule += (proxMonth||'*')+'-'+(proxDOM||'*')+' ';
      }
      schedule += proxHour;
      if (proxMin) schedule += ':'+proxMin;
      return {schedule: schedule.trim()};
    }
    function convert() {
      const cron = document.getElementById('cron').value;
      const out = cronToProxmox(cron);
      const result = document.getElementById('result');
      if (out.error) {
        result.innerHTML = '<span class="error">'+out.error+'</span>';
        result.style.display = 'flex';
      } else {
        result.innerHTML = '<span style="word-break:break-all;">'+out.schedule+'</span>' +
          '<button class="copy-btn" title="Kopiuj" onclick="copyResult(event)"><i class="fa-solid fa-copy"></i></button>';
        result.style.display = 'flex';
      }
    }
    function setExample(cron) {
      document.getElementById('cron').value = cron;
      convert();
      document.getElementById('cron').focus();
    }
    function copyResult(e) {
      e.stopPropagation();
      const text = document.querySelector('#result span').textContent;
      navigator.clipboard.writeText(text);
      const btn = e.currentTarget;
      btn.innerHTML = '<i class="fa-solid fa-check"></i>';
      setTimeout(()=>{ btn.innerHTML = '<i class="fa-solid fa-copy"></i>'; }, 1200);
    }
  </script>
</body>
</html>